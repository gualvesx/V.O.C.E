<!DOCTYPE html>
<html lang="pt-br">
    <head>
        <%- include('partials/header') %>
        </head>
<body class="bg-gray-100 flex flex-col min-h-screen">
    
    <header class="bg-white shadow-md border-b-2 border-gray-100 sticky top-0 z-40">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 flex justify-between items-center h-20">
            <a href="/"><img src="https://upload.wikimedia.org/wikipedia/commons/8/8c/SENAI_S%C3%A3o_Paulo_logo.png" alt="Logo SENAI" class="h-10"></a>
            <div class="flex items-center space-x-6">
                <a href="/dashboard" class="text-gray-600 hover:text-red-700 font-semibold transition-colors duration-200 text-sm uppercase tracking-wider">
                    Dashboard
                </a>
                <a href="/logout" class="inline-block px-4 py-2 rounded-md font-semibold text-center uppercase tracking-wider text-xs transition-transform duration-200 transform hover:scale-105 focus:outline-none focus:ring-2 focus:ring-offset-2 bg-red-700 text-white hover:bg-red-800 focus:ring-red-500">
                    Sair
                </a>
            </div>
        </div>
    </header>

    <main class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8 flex-grow w-full">
        <div class="max-w-2xl mx-auto space-y-8">
            <div class="bg-white rounded-lg shadow-lg p-8 border-t-4 border-red-700">
                <h1 class="text-2xl font-bold text-gray-900 mb-6">Meu Perfil</h1>

                <% if (success) { %>
                    <div class="bg-green-100 border-l-4 border-green-500 text-green-700 p-4 mb-6 rounded-r-lg" role="alert">
                        <p class="font-bold">Sucesso!</p>
                        <p>O seu nome foi atualizado.</p>
                    </div>
                <% } %>
                
                <form action="/perfil" method="POST" class="space-y-6">
                    <div>
                        <label for="fullName" class="block text-sm font-medium text-gray-700">Nome Completo</label>
                        <input type="text" id="fullName" name="fullName" value="<%= user.full_name %>" class="mt-1 form-input">
                    </div>
                    <div>
                        <label for="username" class="block text-sm font-medium text-gray-700">Nome de Utilizador (não pode ser alterado)</label>
                        <input type="text" id="username" name="username" value="<%= user.username %>" class="mt-1 form-input bg-gray-100 text-gray-500" disabled>
                    </div>
                    <div class="flex justify-end">
                        <button type="submit" class="btn-submit">
                            Salvar Alterações
                        </button>
                    </div>
                </form>
            </div>

            <!-- Seção para Mudar Senha -->
            <div class="bg-white rounded-lg shadow-lg p-8 border-t-4 border-red-700">
                <h2 class="text-2xl font-bold text-gray-900 mb-6">Mudar Senha</h2>
                <div id="password-feedback" class="hidden p-4 mb-4 rounded-lg"></div>
                <form id="changePasswordForm" class="space-y-6">
                    <div>
                        <label for="newPassword" class="block text-sm font-medium text-gray-700">Nova Senha</label>
                        <input type="password" id="newPassword" required class="mt-1 form-input" minlength="6">
                    </div>
                    <div>
                        <label for="confirmPassword" class="block text-sm font-medium text-gray-700">Confirmar Nova Senha</label>
                        <input type="password" id="confirmPassword" required class="mt-1 form-input" minlength="6">
                    </div>
                    <div class="flex justify-end">
                        <button type="submit" class="btn-submit">
                            Mudar Senha
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </main>

    <footer class="bg-red-800 text-white mt-auto">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-6 text-center">
            <p class="text-sm">&copy; <%= new Date().getFullYear() %> SENAI - Todos os direitos reservados.</p>
        </div>
    </footer>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
        import { getAuth, onAuthStateChanged, updatePassword } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";

        const firebaseConfig = {
            apiKey: "AIzaSyDznqrm2kJfKQXxWpgHWwk-msXH89OEgTo",
            authDomain: "banco-vc.firebaseapp.com",
            projectId: "banco-vc",
            storageBucket: "banco-vc.appspot.com",
            messagingSenderId: "858410245985",
            appId: "1:858410245985:web:56fae7da4c145c30a32f20",
            measurementId: "G-4E7K9TY3B7"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);

        const changePasswordForm = document.getElementById('changePasswordForm');
        const feedbackDiv = document.getElementById('password-feedback');

        onAuthStateChanged(auth, (user) => {
            if (user) {
                changePasswordForm.addEventListener('submit', async (e) => {
                    e.preventDefault();
                    feedbackDiv.classList.add('hidden');

                    const newPassword = document.getElementById('newPassword').value;
                    const confirmPassword = document.getElementById('confirmPassword').value;

                    if (newPassword.length < 6) {
                        showFeedback('A nova senha deve ter pelo menos 6 caracteres.', 'error');
                        return;
                    }
                    if (newPassword !== confirmPassword) {
                        showFeedback('As senhas não coincidem.', 'error');
                        return;
                    }

                    try {
                        await updatePassword(user, newPassword);
                        showFeedback('Senha alterada com sucesso!', 'success');
                        changePasswordForm.reset();
                    } catch (error) {
                        console.error("Erro ao mudar a senha:", error);
                        showFeedback('Erro ao mudar a senha. Tente fazer login novamente.', 'error');
                    }
                });
            } else {
                // Usuário não está logado, desabilitar o formulário
                changePasswordForm.style.opacity = '0.5';
                const inputs = changePasswordForm.querySelectorAll('input, button');
                inputs.forEach(input => input.disabled = true);
            }
        });
        
        function showFeedback(message, type) {
            feedbackDiv.textContent = message;
            if (type === 'success') {
                feedbackDiv.className = 'bg-green-100 text-green-700 p-4 mb-4 rounded-lg';
            } else {
                feedbackDiv.className = 'bg-red-100 text-red-700 p-4 mb-4 rounded-lg';
            }
            feedbackDiv.classList.remove('hidden');
        }

    </script>
</body>
</html>

<!DOCTYPE html>
<html lang="pt-br">
    <head>
        <%- include('partials/header') %>
        </head>
<body class="bg-gray-100 flex flex-col min-h-screen">
    <header class="bg-white shadow-md border-b-2 border-gray-100">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 flex justify-between items-center h-20">
            <a href="/"><img src="https://upload.wikimedia.org/wikipedia/commons/8/8c/SENAI_S%C3%A3o_Paulo_logo.png" alt="Logo SENAI" class="h-10"></a>
        </div>
    </header>

    <main class="flex-grow flex items-center justify-center py-12 px-4">
        <div class="max-w-md w-full bg-white p-8 rounded-xl shadow-2xl border-t-4 border-red-700">
            <h2 class="text-center text-2xl font-bold text-gray-900">Criar Nova Conta</h2>
            <p class="mt-2 text-center text-sm text-gray-600">Registe o seu perfil de professor.</p>
            
            <form class="mt-8 space-y-6" id="cadastroForm">
                <div class="space-y-4">
                    <div>
                        <label for="fullName" class="block text-sm font-medium text-gray-700">Nome Completo</label>
                        <input id="fullName" name="fullName" type="text" required class="mt-1 form-input">
                    </div>
                    <div>
                        <label for="username" class="block text-sm font-medium text-gray-700">Nome de Utilizador</label>
                        <input id="username" name="username" type="text" required class="mt-1 form-input" placeholder="ex: prof.leo">
                    </div>
                     <div>
                        <label for="email" class="block text-sm font-medium text-gray-700">Email</label>
                        <input id="email" name="email" type="email" required class="mt-1 form-input">
                    </div>
                    <div>
                        <label for="password" class="block text-sm font-medium text-gray-700">Senha</label>
                        <input id="password" name="password" type="password" required class="mt-1 form-input" minlength="6">
                        <p class="text-xs text-gray-500 mt-1">Mínimo 6 caracteres, com maiúscula, minúscula e número.</p>
                    </div>
                </div>

                <div id="error-message" class="hidden bg-red-100 border border-red-200 rounded-lg p-4 mt-4">
                    <p class="text-sm text-red-700"></p>
                </div>

                <div class="pt-2">
                    <button type="submit" class="btn-submit">Registar Conta</button>
                </div>
                <div class="text-center text-sm mt-4">
                    <p class="text-gray-600">
                        Já tem uma conta? 
                        <a href="/login" class="font-medium text-red-700 hover:text-red-800">Faça login aqui!</a>
                    </p>
                </div>
            </form>
        </div>
    </main>

    <footer class="bg-red-700 text-white mt-auto">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-6 text-center">
            <p>&copy; <%= new Date().getFullYear() %> SENAI - Todos os direitos reservados.</p>
        </div>
    </footer>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
        import { getAuth, createUserWithEmailAndPassword } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
        
        const firebaseConfig = {
            apiKey: "AIzaSyDznqrm2kJfKQXxWpgHWwk-msXH89OEgTo",
            authDomain: "banco-vc.firebaseapp.com",
            projectId: "banco-vc",
            storageBucket: "banco-vc.appspot.com",
            messagingSenderId: "858410245985",
            appId: "1:858410245985:web:56fae7da4c145c30a32f20",
            measurementId: "G-4E7K9TY3B7"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);

        const form = document.getElementById('cadastroForm');
        const errorMessageDiv = document.getElementById('error-message');

        form.addEventListener('submit', async (e) => {
            e.preventDefault();
            errorMessageDiv.classList.add('hidden');

            const fullName = form.fullName.value;
            const username = form.username.value;
            const email = form.email.value;
            const password = form.password.value;

            try {
                // Passo 1: Cria o usuário apenas no Firebase Authentication.
                const userCredential = await createUserWithEmailAndPassword(auth, email, password);
                const uid = userCredential.user.uid;

                // Passo 2: Se a criação no Auth for bem-sucedida, envia os dados do perfil para o nosso backend.
                const response = await fetch('/createProfile', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        uid: uid,
                        fullName: fullName,
                        username: username
                    })
                });

                if (!response.ok) {
                    // Se o backend falhar ao criar o perfil, o erro será capturado aqui.
                    const errorData = await response.json();
                    throw new Error(errorData.error || 'Falha ao criar o perfil no servidor.');
                }
                
                // Passo 3: Se tudo correu bem, redireciona para o login.
                window.location.href = '/login?message=Cadastro realizado com sucesso! Pode fazer o login.';

            } catch (error) {
                console.error("Erro no cadastro:", error);
                let friendlyMessage = "Não foi possível criar o usuário. Verifique os dados.";
                
                // Trata erros específicos do Firebase Authentication.
                if (error.code === 'auth/email-already-in-use') {
                    friendlyMessage = 'Este e-mail já está em uso por outra conta.';
                } else if (error.code === 'auth/weak-password') {
                    friendlyMessage = 'A senha é muito fraca. Utilize pelo menos 6 caracteres.';
                } else if (error.message) {
                    // Trata erros vindos do nosso backend (lançados com "throw new Error(...)").
                    friendlyMessage = error.message;
                }
                
                errorMessageDiv.querySelector('p').textContent = friendlyMessage;
                errorMessageDiv.classList.remove('hidden');
            }
        });
    </script>
</body>
</html>


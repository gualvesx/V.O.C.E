<!DOCTYPE html>
<html lang="pt-br">
    <head>
        <%- include('partials/header') %>
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css" integrity="sha512-DTOQO9RWCH3ppGqcWaEA1BIZOC6xxalwEsw9c2QQeAIftl+Vegovlnee1c9QX4TctnWMn13TZye+giMm8e2LwA==" crossorigin="anonymous" referrerpolicy="no-referrer" />
        <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
        <style>
             /* Estilos básicos (ajuste conforme seu style.css) */
            .form-input { appearance: none; border-radius: 0.375rem; border-width: 1px; border-color: #D1D5DB; padding: 0.5rem 1rem; width: 100%; box-shadow: 0 1px 2px 0 rgba(0, 0, 0, 0.05); }
            .form-input:focus { outline: 2px solid transparent; outline-offset: 2px; box-shadow: var(--tw-ring-offset-shadow, 0 0 #0000), var(--tw-ring-shadow, 0 0 #0000), var(--tw-shadow, 0 0 #0000); --tw-ring-color: rgba(220, 38, 38, 0.5); border-color: #DC2626; }
            .btn-submit { display: inline-block; width: 100%; padding: 0.625rem 1.5rem; border-radius: 0.375rem; font-weight: 600; text-align: center; text-transform: uppercase; letter-spacing: 0.05em; font-size: 0.875rem; background-color: #DC2626; color: white; cursor: pointer; transition: background-color 0.2s; }
            .btn-submit:hover { background-color: #B91C1C; }
            .btn-submit:disabled { opacity: 0.5; cursor: not-allowed; }
        </style>
    </head>
<body class="bg-gray-100 flex flex-col min-h-screen">
    <header class="bg-white shadow-md border-b-2 border-gray-100">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 flex justify-between items-center h-20">
            <a href="/"><img src="https://upload.wikimedia.org/wikipedia/commons/8/8c/SENAI_S%C3%A3o_Paulo_logo.png" alt="Logo SENAI" class="h-10"></a>
        </div>
    </header>

    <main class="flex-grow flex items-center justify-center py-12 px-4">
        <div class="max-w-md w-full bg-white p-8 rounded-xl shadow-2xl border-t-4 border-red-700">
            <h2 class="text-center text-2xl font-bold text-gray-900">Acessar o Painel</h2>
            <p class="mt-2 text-center text-sm text-gray-600">Bem-vindo de volta! Faça o login para continuar.</p>

            <% if (typeof message !== 'undefined' && message === 'Cadastro realizado com sucesso!') { %>
                <div id="success-message" class="bg-green-100 border border-green-200 text-green-700 px-4 py-3 rounded relative my-4" role="alert">
                    <span class="block sm:inline"><%= message %></span>
                </div>
            <% } %>

            <div id="error-message" class="hidden bg-red-100 border border-red-200 text-red-700 px-4 py-3 rounded relative my-4" role="alert">
                <p class="text-sm"></p>
            </div>

            <form class="mt-8 space-y-6" id="loginForm">
                <div class="space-y-4">
                    <div>
                        <label for="email" class="block text-sm font-medium text-gray-700">Email</label>
                        <input id="email" name="email" type="email" autocomplete="email" required class="mt-1 form-input" placeholder="Digite seu email">
                    </div>
                    <div>
                        <label for="password" class="block text-sm font-medium text-gray-700">Senha</label>
                        <div class="relative mt-1">
                            <input id="password" name="password" type="password" autocomplete="current-password" required
                                   class="form-input pr-10"
                                   placeholder="Digite sua senha">
                            <span id="togglePassword"
                                  class="absolute inset-y-0 right-0 pr-3 flex items-center cursor-pointer text-gray-400 hover:text-gray-600">
                                <i class="fas fa-eye"></i>
                            </span>
                        </div>
                    </div>
                </div>
                <div class="pt-2">
                    <button type="submit" class="btn-submit w-full">
                         Entrar no Sistema
                    </button>
                </div>
                <div class="flex justify-between items-center text-sm mt-4">
                    <p class="text-gray-600">
                        Não tem uma conta?
                        <a href="/cadastro" class="font-medium text-red-700 hover:text-red-800">Cadastre-se!</a>
                    </p>
                    <a href="#" id="forgotPasswordLink" class="font-medium text-red-700 hover:text-red-800">Esqueceu a senha?</a>
                </div>
            </form>
        </div>
    </main>
    
    <div id="resetPasswordModal" class="hidden fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full flex items-center justify-center z-50">
         <div class="relative mx-auto p-8 border w-96 shadow-lg rounded-md bg-white">
            <h3 class="text-lg font-medium text-gray-900">Redefinir Senha</h3>
            <div class="mt-4">
                <p class="text-sm text-gray-600 mb-4">Por favor, insira o seu email para enviarmos um link de redefinição de senha.</p>
                <form id="resetPasswordForm">
                    <label for="resetEmail" class="block text-sm font-medium text-gray-700">Email</label>
                    <input type="email" id="resetEmail" required class="mt-1 form-input w-full">
                    <div class="flex justify-end gap-4 mt-6">
                        <button type="button" id="cancelReset" class="px-4 py-2 bg-gray-200 text-gray-800 rounded hover:bg-gray-300">Cancelar</button>
                        <button type="submit" class="px-4 py-2 bg-red-700 text-white rounded hover:bg-red-800">Enviar</button>
                    </div>
                </form>
            </div>
        </div>
    </div>
    <footer class="bg-red-700 text-white mt-auto">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-6 text-center">
            <p class="text-sm">&copy; <%= new Date().getFullYear() %> SENAI - Todos os direitos reservados.</p>
        </div>
    </footer>

    <script>
        // O script completo que você já tem, com toda a lógica, permanece o mesmo.
        // Cole-o aqui.
        document.addEventListener('DOMContentLoaded', () => {
            const loginForm = document.getElementById('loginForm');
            const errorMessageDiv = document.getElementById('error-message');
            const successMessageDiv = document.getElementById('success-message');

            // Exibe msg de sucesso do cadastro
            const urlParams = new URLSearchParams(window.location.search);
            const registerMessage = urlParams.get('message');
            if (registerMessage && registerMessage === 'Cadastro realizado com sucesso!' && successMessageDiv) {
                successMessageDiv.querySelector('p').textContent = registerMessage;
                successMessageDiv.classList.remove('hidden');
                window.history.replaceState({}, document.title, "/login");
            } else if (successMessageDiv) {
                successMessageDiv.classList.add('hidden');
            }

             // Exibe msg de erro do backend (se houver)
             const serverErrorMessage = '<%= (typeof message !== "undefined" && message && message !== "Cadastro realizado com sucesso!") ? message : "" %>';
             if (serverErrorMessage && errorMessageDiv) {
                  errorMessageDiv.querySelector('p').textContent = serverErrorMessage;
                  errorMessageDiv.classList.remove('hidden');
             } else if (errorMessageDiv) {
                  errorMessageDiv.classList.add('hidden');
             }

            // --- LOGIN FORM SUBMISSION (Fetch/AJAX) ---
            if(loginForm){
                loginForm.addEventListener('submit', async (e) => {
                    e.preventDefault();
                    if(errorMessageDiv) errorMessageDiv.classList.add('hidden');
                    if (successMessageDiv) successMessageDiv.classList.add('hidden');

                    const formData = new FormData(loginForm);
                    const data = Object.fromEntries(formData.entries());

                    const submitButton = loginForm.querySelector('button[type="submit"]');
                    const originalButtonText = submitButton.textContent;
                    submitButton.disabled = true;
                    submitButton.textContent = 'Entrando...';

                    try {
                        const response = await fetch('/login', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify(data)
                        });
                        const result = await response.json();
                        if (!response.ok) throw new Error(result.message || `Erro ${response.status}`);
                        window.location.href = '/dashboard'; // Redirect on success
                    } catch (error) {
                        console.error("Erro no login via fetch:", error);
                        Swal.fire({ icon: 'error', title: 'Falha no Login', text: error.message || 'Não foi possível fazer login.' });
                    } finally {
                        if(submitButton){ submitButton.disabled = false; submitButton.textContent = originalButtonText; }
                    }
                });
            }
            // --- END LOGIN FORM ---

            // --- PASSWORD VISIBILITY TOGGLE ---
            const passwordInput = document.getElementById('password');
            const toggleIconSpan = document.getElementById('togglePassword');
            const eyeIcon = toggleIconSpan ? toggleIconSpan.querySelector('i') : null;
            if (passwordInput && toggleIconSpan && eyeIcon) {
                toggleIconSpan.addEventListener('click', () => {
                    const type = passwordInput.getAttribute('type') === 'password' ? 'text' : 'password';
                    passwordInput.setAttribute('type', type);
                    eyeIcon.className = `fas ${type === 'password' ? 'fa-eye' : 'fa-eye-slash'}`;
                });
            }
            // --- END PASSWORD VISIBILITY ---

            // --- FORGOT PASSWORD MODAL LOGIC ---
            const forgotPasswordLink = document.getElementById('forgotPasswordLink');
            const resetModal = document.getElementById('resetPasswordModal');
            const cancelResetBtn = document.getElementById('cancelReset');
            const resetForm = document.getElementById('resetPasswordForm');

            if (forgotPasswordLink && resetModal && cancelResetBtn && resetForm) {
                // Open modal
                forgotPasswordLink.addEventListener('click', (e) => {
                    e.preventDefault();
                    resetModal.classList.remove('hidden');
                    document.getElementById('resetEmail').value = ''; // Clear email field
                });

                // Close modal on cancel
                cancelResetBtn.addEventListener('click', () => {
                    resetModal.classList.add('hidden');
                });

                 // Close modal on overlay click
                 resetModal.addEventListener('click', (e) => {
                     if (e.target === resetModal) {
                         resetModal.classList.add('hidden');
                     }
                 });

                // Handle form submission
                resetForm.addEventListener('submit', async (e) => {
                     e.preventDefault();
                     const email = document.getElementById('resetEmail').value;
                     const submitButton = resetForm.querySelector('button[type="submit"]');
                     const originalButtonText = submitButton.textContent;
                     submitButton.disabled = true;
                     submitButton.textContent = 'Enviando...';

                     try {
                         const response = await fetch('/forgot-password', {
                             method: 'POST',
                             headers: { 'Content-Type': 'application/json' },
                             body: JSON.stringify({ email })
                         });
                         const result = await response.json();
                         resetModal.classList.add('hidden');
                         if (!response.ok || !result.success) {
                             throw new Error(result.message || 'Falha ao processar solicitação.');
                         }
                         Swal.fire('Verifique seu Email', result.message, 'info');
                     } catch (error) {
                         console.error("Erro ao solicitar redefinição:", error);
                         Swal.fire('Verifique seu Email', 'Se o email estiver cadastrado, um link de redefinição foi enviado.', 'info');
                     } finally {
                          if(submitButton){
                              submitButton.disabled = false;
                              submitButton.textContent = originalButtonText;
                          }
                     }
                });
            }
            // --- END FORGOT PASSWORD LOGIC ---
        });
    </script>
</body>
</html>